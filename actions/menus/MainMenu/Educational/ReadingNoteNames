<?xml version="1.0"?>
<Denemo>
  <merge>
    <title>A Denemo Keymap</title>
    <author>AT, JRR, RTS</author>
    <map>
      <row>
        <action>ReadingNoteNames</action>
        <scheme>
;; tests note name recognition.

;; set the random seed up using time of day
     (let ((time (gettimeofday)))
       (set! *random-state*
             (seed->random-state (+ (car time)
                                    (cdr time)))))

;; utility functions to shift the cursor up or down by a number of diatonic steps
(define shiftup
  (lambda (n)
    (if (> n 0) (begin
	(d-CursorUp)
	(shiftup (- n 1))))))

(define shiftdown
  (lambda (n)
    (if (> n 0) (begin
	(d-CursorDown)
	(shiftdown (- n 1))))))


;; define the variables and constants used - should these be local?
(define notewas #t) ;; the note displayed
(define usernote #t) ;; the user's response to the note
(define score 0)  ;; simple score (correct minus incorrect)
(define steps 0)  ;; note for testing will be steps above the cursor
(define span 8) ;; how many steps of the scale to test, starting from the cursor position.
(define number-to-test 16) ;; how many notes to present for the test before giving a final score.
(define runtest 
  (lambda (n)
    (if (> n 0) (begin
		  (set! steps (+ 1 (random span)))
		  (shiftup steps)
		  (d-Insert2)
		  (set! notewas (d-GetNoteName))
		  (d-InsertLilyDirective (string-append  "%Your score so far: " (object->string score)))
		  (shiftdown steps)
		  (set! usernote (d-getUserInput "Reading Test" "Give note name" "?"))
		  (if (string? usernote)
		      (begin
		  (d-DeletePreviousObject) ;; delete the prompt giving the old score
		  (if  (string=? notewas usernote)
		       (begin
		       (set! score (+ score 1))
		       (d-ChangeNotehead "Diamond"))
		       (begin
		       (set! score (- score 1))
		       (d-ChangeNotehead "Cross"))) 		 
		  (runtest (- n 1))))))))

(runtest number-to-test)
(d-InsertLilyDirective (string-append  "%Final Score: " (object->string score)))
(d-AppendMeasure)
(d-AppendMeasure)
(d-MeasureRight)
(d-MeasureRight)


</scheme>
        <menupath>/MainMenu/Educational/MusicReading</menupath>
        <label>Note Name Recognition</label>
        <tooltip>%tests your ability to name the notes of the scale</tooltip>
      </row>
    </map>
  </merge>
</Denemo>
