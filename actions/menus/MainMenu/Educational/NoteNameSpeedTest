<?xml version="1.0"?>
<Denemo>
  <merge>
    <title>A Denemo Keymap</title>
    <author>AT, JRR, RTS</author>
    <map>
      <row>
        <after/>
        <action>NoteNameSpeedTest</action>
        <scheme>;;;;;;;;;;;;;;;
;;NoteNameSpeedTest NEW VERSION
;; tests note name recognition.


(define NoteNameSpeedTest::score 0)
(define NoteNameSpeedTest::note_position 6) ;0 = middle c
(define NoteNameSpeedTest::note_highest 11)
(define NoteNameSpeedTest::note_lowest 0)
(define NoteNameSpeedTest::start 0)
(define NoteNameSpeedTest::end 0)
(define NoteNameSpeedTest::TimeLimit 120)
(define NoteNameSpeedTest::notewas #f)

(define (NoteNameSpeedTest::ElapsedTime)
  (- NoteNameSpeedTest::end NoteNameSpeedTest::start))

(define (NoteNameSpeedTest::showscore)
  (d-DirectivePut-score-display "NoteNameSpeedTest::GameScore" (string-append "&lt;b&gt;Score: " 
    (object-&gt;string NoteNameSpeedTest::score) "&lt;/b&gt; in " 
    (object->string (NoteNameSpeedTest::ElapsedTime)) " Secs.")))

(define (NoteNameSpeedTest::GameOverDialog)
   (d-InfoDialog (string-append "Game Over\n" "Your Score = " (number->string NoteNameSpeedTest::score))))

(define (NoteNameSpeedTest::ScoreBoard)
    (d-InfoDialog (EducationGames::Scoreboard_Pretty_Print 
      (EducationGames::ScoreboardFile "NoteNameSpeedTest"))))

(define (NoteNameSpeedTest::Chime)
  (d-PlayMidiKey #xF03001)
  (d-PlayMidiKey #xF02A01)
  (d-PlayMidiKey #xF04001))

;;;;;;;;; callback when user chooses a note
(define (NoteNameSpeedTest::notechosen usernote)
		      (begin
			(set! NoteNameSpeedTest::end (current-time))
			(let gotoEnd () (if  (d-NextObject) (gotoEnd)))
			(if  (string=? NoteNameSpeedTest::notewas usernote)
			     (begin
			       (set! NoteNameSpeedTest::score (+ NoteNameSpeedTest::score 1))
			       (EducationGames::PlaceAnswerStatus "CheckMark")
			       (d-ChangeNotehead "Diamond"))
			     (begin
			       (set! NoteNameSpeedTest::score (- NoteNameSpeedTest::score 1))
			       (EducationGames::PlaceAnswerStatus "CrossSign")
			       (d-ChangeNotehead "Cross"))) 
			(NoteNameSpeedTest::offerNote)))


(define (NoteNameSpeedTest::print)
 (d-DeletePreviousObject)
 (SetHeaderField "title" "Note Naming Game")
 (SetHeaderField "subtitle" (string-append "Score was: "  (object-&gt;string NoteNameSpeedTest::score) 
  " in "  (object-&gt;string (- NoteNameSpeedTest::end NoteNameSpeedTest::start)) " Seconds"))
 (SetHeaderField "piece" "user: anonymous")
 (d-DirectivePut-paper-postfix "PrintAllHeaders" "printallheaders = ##t\n")
 (d-PrintPreview)
 (d-DirectiveDelete-header "Movement-title")
 (d-DirectiveDelete-header "Movement-subtitle")
 (d-DirectiveDelete-header "Movement-piece")
 (NoteNameSpeedTest::offerNote)
 (d-SetSaved))

(define (NoteNameSpeedTest::help) 
  (d-InfoDialog "Identify the note that appears on the staff. Then hit the notename on the keyboard. Be quick because you have a time limit!!!"))

;;;
(define (NoteNameSpeedTest::GetKeyBoardInput) 
	(if (>= (NoteNameSpeedTest::ElapsedTime) NoteNameSpeedTest::TimeLimit)
	  (begin
	    (NoteNameSpeedTest::GameOver))
	  (begin
            (NoteNameSpeedTest::notechosen (d-GetKeypress))
	    (NoteNameSpeedTest::GetKeyBoardInput)))
	  )

(define (NoteNameSpeedTest::go)
  (if (not (zero? NoteNameSpeedTest::score))
      (let ((response #f))
	(set! response (d-GetUserInput "Reset Score" "Do you want to reset your score" "y"))
	(if (equal? response "y")
	      (set! NoteNameSpeedTest::score 0))))
  
  (d-DeletePreviousObject)
  (NoteNameSpeedTest::Chime)
  (set! NoteNameSpeedTest::start (current-time))
  (set! NoteNameSpeedTest::end (current-time))
  (NoteNameSpeedTest::offerNote)
  (NoteNameSpeedTest::GetKeyBoardInput))

(define (NoteNameSpeedTest::offerNote) 
	(let (    
	      (outofrange? 0)
	      (seed 0)
	      )
	      (set! outofrange?
	        (lambda ()
		  (or (> NoteNameSpeedTest::note_position NoteNameSpeedTest::note_highest) 
		      (> NoteNameSpeedTest::note_lowest NoteNameSpeedTest::note_position)) 
			))
	      (set! seed 
	        (lambda ()
	          (if (= (random 2) 0)
	            (set! NoteNameSpeedTest::note_position (+ NoteNameSpeedTest::note_position 1))
		    (set! NoteNameSpeedTest::note_position (- NoteNameSpeedTest::note_position 1)))
		    (if (outofrange?)
		      (seed))
		    ))

          (seed)
	  ;;  (d-GoToEnd)
	  (let gotoEnd () (if  (d-NextObject) (gotoEnd)))

	  (d-CursorToNote (EducationalGames::middle_c_offset->lily NoteNameSpeedTest::note_position))
	  (d-Insert1)
	  (set! NoteNameSpeedTest::notewas (d-GetNoteName))
	   
	  (NoteNameSpeedTest::showscore)
	  ))


(CreateButton "NoteNameSpeedTest::GameScore" "&lt;span font_desc=\"22\"&gt;Score&lt;/span&gt;")
(d-SetDirectiveTagActionScript "NoteNameSpeedTest::GameScore" "(NoteNameSpeedTest::ScoreBoard)")

(CreateButton "NoteNameSpeedTest::GameHelp" "&lt;b&gt;Help&lt;/b&gt;")
(d-SetDirectiveTagActionScript "NoteNameSpeedTest::GameHelp" "(NoteNameSpeedTest::help)")

(CreateButton "NoteNameSpeedTest::GameGo" "&lt;span font_desc=\"22\"&gt;Start&lt;/span&gt;")
(d-SetDirectiveTagActionScript "NoteNameSpeedTest::GameGo" "(NoteNameSpeedTest::go)")

(CreateButton "NoteNameSpeedTest::GamePrint" "&lt;span font_desc=\"22\"&gt;Print&lt;/span&gt;")
(d-SetDirectiveTagActionScript "NoteNameSpeedTest::GamePrint" "(NoteNameSpeedTest::print)")


(define (NoteNameSpeedTest::GameOver)
   (NoteNameSpeedTest::Chime)
    (if (not 
      (EducationGames::Write_Scoreboard_File 
      (EducationGames::ScoreboardFile "NoteNameSpeedTest") NoteNameSpeedTest::score))
      (NoteNameSpeedTest::GameOverDialog)
      (NoteNameSpeedTest::ScoreBoard)
    ))
</scheme>
        <label>Note Name Speed Recognition</label>
        <tooltip>%tests your ability to name the notes of the scale</tooltip>
      </row>
    </map>
  </merge>
</Denemo>
