<?xml version="1.0"?>
<Denemo>
  <merge>
    <title>A Denemo Keymap</title>
    <author>AT, JRR, RTS</author>
    <map>
      <row>
        <action>LineOrSpace</action>
        <scheme>;;;;;;;;;;;;;;;
;;LineOrSpace
;; tests note name recognition.

(define LineOrSpace::positionwas #t)
(define LineOrSpace::userinput #t)
(define LineOrSpace::start (current-time))
(define LineOrSpace::end (current-time))
(define LineOrSpace::score 0)
(define LineOrSpace::steps 0)
(define LineOrSpace::position 0)
(define LineOrSpace::span 8) ;; how many LineOrSpace::steps of the scale to test.
(define LineOrSpace::num-goes 30) ;; how many notes to present for the whole test
      
(define (LineOrSpace::showscore)
  (d-DirectivePut-score-display "LineOrSpace::GameScore" (string-append "&lt;b&gt;Score: " (object-&gt;string LineOrSpace::score) "&lt;/b&gt; in " (object-&gt;string (- LineOrSpace::end LineOrSpace::start)) " Secs.")))

(define (LineOrSpace::help) 
  (d-InfoDialog "Click on the *Spacebar* if the note is on a space and the *L* key if it is on a line.")
)

(define (LineOrSpace::GameOver)
   (d-InfoDialog (string-append "Game Over\n" "Your Score = " (number->string LineOrSpace::score)))
)

(define (LineOrSpace::ScoreBoard)
    (d-InfoDialog (EducationGames::Scoreboard_Pretty_Print 
      (EducationGames::ScoreboardFile "LineOrSpace")))
)

(CreateButton "LineOrSpace::GameScore" "&lt;span font_desc=\"12\"&gt;Score&lt;/span&gt;")
(d-SetDirectiveTagActionScript "LineOrSpace::GameScore" "(LineOrSpace::ScoreBoard)")
(CreateButton "LineOrSpace::GameHelp" "&lt;b&gt;Help&lt;/b&gt;")
(d-SetDirectiveTagActionScript "LineOrSpace::GameHelp" "(LineOrSpace::help)")

(define (LineOrSpace::offerNote) 
(if (>= LineOrSpace::num-goes 0)
	(let (    
	      (steps 0)
	      (direction 0)
	      )
	;;  (d-GoToEnd)
	  (let gotoEnd () (if  (d-NextObject) (gotoEnd)))
	  (set! LineOrSpace::steps (+ 1 (random LineOrSpace::span)))
	  (EducationGames::shiftup LineOrSpace::steps)
	  (set! LineOrSpace::position (+ LineOrSpace::steps))
	  (d-Insert2)
		
	  (if (odd? LineOrSpace::position)
	    (begin
        	(set! LineOrSpace::positionwas "space"))
	    (begin
		(set! LineOrSpace::positionwas "line")))
		(EducationGames::shiftdown LineOrSpace::steps)
	        (set! LineOrSpace::position (- LineOrSpace::steps))

	   (LineOrSpace::showscore)
	   (set! LineOrSpace::num-goes (-  LineOrSpace::num-goes 1))
	  )
	))

;;;;;;;;; callback when user chooses a note
(define (LineOrSpace::positionchosen userinput)
	(if (>= LineOrSpace::num-goes 0)
		(begin
			(set! LineOrSpace::end (current-time))
			(let gotoEnd () (if  (d-NextObject) (gotoEnd)))	
			(if  (string=? LineOrSpace::positionwas userinput)
			     (begin
			       (set! LineOrSpace::score (+ LineOrSpace::score 1))
			       (EducationGames::PlaceAnswerStatus "CheckMark")
			       (d-ChangeNotehead "Diamond"))
			     (begin
			       (set! LineOrSpace::score (- LineOrSpace::score 1))
			       (EducationGames::PlaceAnswerStatus "CrossSign")
			       (d-ChangeNotehead "Cross"))) 
			(LineOrSpace::offerNote)
			       )))
	

;;;;;;;; the main function to run the test
(define LineOrSpace::runtest 
	(lambda (n)
	  (if (>= n 0) (begin
	    		(set! LineOrSpace::userinput (d-GetKeypress))
			(if (string=? LineOrSpace::userinput "l")
			  (set! LineOrSpace::userinput "line"))
			(LineOrSpace::positionchosen LineOrSpace::userinput)	
			(LineOrSpace::runtest LineOrSpace::num-goes)))))


(define (LineOrSpace::createbuttons position)
  (CreateButton (string-append "LineOrSpace::" position)  (string-append " &lt;span font_desc=\"32\" foreground=\"blue\"&gt;" position  "&lt;/span&gt;"))
  (d-SetDirectiveTagActionScript  (string-append "LineOrSpace::" position) (string-append "(LineOrSpace::positionchosen \"" position "\")")))

(LineOrSpace::createbuttons "line")
(LineOrSpace::createbuttons "space")




  (d-PlayMidiKey #xF03001)
  (d-PlayMidiKey #xF02A01)
  (d-PlayMidiKey #xF04001)

(LineOrSpace::offerNote)
(set! LineOrSpace::start (current-time))
(LineOrSpace::runtest LineOrSpace::num-goes)
(if (not 
  (EducationGames::Write_Scoreboard_File 
  (EducationGames::ScoreboardFile "LineOrSpace") LineOrSpace::score))
  (LineOrSpace::GameOver)
  (LineOrSpace::ScoreBoard)
  )

  (d-PlayMidiKey #xF03001)
  (d-PlayMidiKey #xF02A01)
  (d-PlayMidiKey #xF04001)
;;;;;;;;;;;;;;;;;;;;;;;;;;

</scheme>
        <label>Line and space recognition</label>
        <tooltip>%tests your ability to recognize the difference between line and space</tooltip>
      </row>
    </map>
  </merge>
</Denemo>
