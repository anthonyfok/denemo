<?xml version="1.0"?>
<Denemo>
  <merge>
    <title>A Denemo Keymap</title>
    <author>AT, JRR, RTS</author>
    <map>
      <row>
        <after>CheckPitches</after>
        <action>ChordsOverBass</action>
        <scheme>;;;;ChordsOverBass (pure filter version)
(define Pitchbend::commandUp "(disp \"disabled\n\")")
(define Pitchbend::commandDown "(disp \"disabled\n\")")

(let ()
  (define (noteOn? midi)
    (= #x90 (bit-extract midi 0 8)))
  (define (noteOff? midi)
    (= #x80 (bit-extract midi 0 8)))
  (define (pedalDown? midi)
    (and (= #xB0 (bit-extract midi 0 8))  (= (bit-extract midi 8 16) #x40) (=  (bit-extract midi 16 24) #x7F)))
  
  (define (pedalUp? midi)
    (and (= #xB0 (bit-extract midi 0 8))  (= (bit-extract midi 8 16) #x40) (=  (bit-extract midi 16 24) #x0)))
 (define (pause) (d-GetUserInput "Pausing..." "Press any key" " "))

;;;start on a tied note. Amalgamate the note(s) tied to with the main note
(define (amalgamate-ties)
  (define this-dur  (string-&gt;number(car (string-split (d-GetNoteDuration) #\.))))
  (define this-dots (d-GetDots))
  (define continuing #t)

  (if (d-NextChordInMeasure)
      (let ((next-dur (string-&gt;number (car (string-split (d-GetNoteDuration) #\.))))
	    (next-dots (d-GetDots)))
	(cond ((and (= this-dur next-dur) (= this-dots next-dots))
	       (d-DeletePreviousObject)
	       (d-Augment))

	      ((and (= 1 this-dots) (= 0 next-dots) (= (/  next-dur 2) this-dur))
	       (d-DeletePreviousObject)
	       (d-RemoveDot)
	       (d-Augment)
	       (d-Augment))

	      ((and (= (/  next-dur 2) this-dur) (= 0 this-dots) (= 0 next-dots))
	       (d-DeletePreviousObject)	       
	       (d-Augment)
	       (d-AddDot))
	      (else (disp "else case\n"))))
      (if (not (d-NextChord))
	  (set! continuing #f)))
  (if (and continuing (d-IsTied))
      (amalgamate-ties)))
		    



;;;;seek back to the chord started but not finished (ie before the rests)
(define (find-suspended-chord)
  (let loop ()
    (disp "looping")
    (if (and (d-PrevChord) (Rest?))
	(loop))))

;;;start with cursor on the rest to be turned into a chord, end back at the same rest or rather the chord that has replaced it
(define (continue-chord)
  (define position #f)
  (find-suspended-chord)
  (set! position (GetPosition))
  (let loop ()
    (define denemodur #f)
    (define numdots 0)
    (d-SetMark)
    (d-Copy)
    (d-ToggleTie)
    (d-NextChord)
    (set! denemodur (number-&gt;string (duration::lilypond-&gt;denemo (string-&gt;number (car (string-split (d-GetNoteDuration)  #\.))))))
    (set! numdots (d-GetDots))
    (d-Paste)
    (d-DeleteObject)
    (if (not (Appending?))
	(d-PrevChord))
    (eval-string (string-append "(d-Change" denemodur ")" (if (&gt; numdots 0) "(d-AddDot)" "")))
    (if (d-NextChord)
	(begin
	  (d-PrevChord)
	  (loop))))
  (apply d-GoToPosition position)
  (amalgamate-ties))
  
      
  (define (GetChords bass-key)
    (define chord-created #f)
    (define suspension #f)
    (define continuing #f)
    (let loop ()
      (let* ((midi (d-GetMidi))
	     (velocity (bit-extract midi 16 24))
	     (note (bit-extract midi 8 16))
	     (command (bit-extract midi 0 8)))  
	(let ()
	  (disp "waiting for the release of " bass-key "\n")
	  (cond
	   ((noteOn? midi)
	    (set! chord-created #t)
	    (if continuing 
			       (begin
			       (disp "cont... " (d-GetNoteForMidiKey note) "\n")
				 (eval-string (string-append "(d-InsertNoteInChord \"" (d-GetNoteForMidiKey note) "\")")))
			       (begin
			        (disp "start... " (d-GetNoteForMidiKey note) "\n")
				 (eval-string (string-append "(d-InsertNoteInChord \"" (d-GetNoteForMidiKey note) "\")"))
				 (set! continuing #t)))
	    (PlayNote (number-&gt;string note) 400)
	    (loop))
	   ((noteOff? midi) 
	    (disp "A note off with chord-created=" chord-created "and suspension=" suspension "\n")
	    (if (= note bass-key)				
				  (if chord-created
				      #t
				      (if suspension
					  (continue-chord);;carry the previous chord on
					  (begin (d-DirectivePut-chord-display  "ChordsOverBass" "Suspension")(disp "rest\n")));;;leave as a rest
				  )				  
				(begin 
(disp "A suspension\n")
				  (set! suspension #t)
				(loop))))
            ;;;here put pedal down condition - creating a new chord over the same note.
	   (else (loop)))))))
  
  (if (not (None?))
      (let loop  ((bass-key (d-GetNoteAsMidi)))
	(define continuing #t)
(d-DirectivePut-chord-graphic "ChordsOverBass" "CheckMark")
	(d-PushPosition)
	(d-SetMark)
	(d-Copy)
	(if (zero? bass-key)
	    (begin
	      (d-MoveToStaffUp)
	      (GoToMeasureEnd)
	      (d-Paste))     
	    (let listening ()
	      (let* ((midi (d-GetMidi))
		     (velocity (bit-extract midi 16 24))
		     (note (bit-extract midi 8 16))
		     (command (bit-extract midi 0 8)))  
		
		  (cond ((and (= command #x90) (= note bass-key))
			 (begin
			   (d-MoveToStaffUp)
			   (GoToMeasureEnd)
			   (d-Paste)
			   (d-MoveCursorLeft)
			   (d-StagedDelete)			   
			   (GetChords bass-key)
			   ))
			((and  (= command #xE0) (&gt; note 32))
			 (disp "Finishing by abort")
(d-DirectiveDelete-chord "ChordsOverBass")
			 (d-PopPosition)
			 (d-MoveToStaffUp)
			 (GoToMeasureEnd)
			 ;(d-RefreshDisplay)
			 ;;;prevent the pitchbend commands running on by waiting for the user to continue on the keyboard before re-instating the normal pitch bend action.
			 (eval-string (string-append "(d-" (d-GetCommandFromUser) ")"))
			 (set! continuing #f))

		      (else
			(disp "Ignoring " command " " note " " velocity " waiting for " bass-key "\n")
			(listening))))))
	(if continuing
	    (begin 
	  ;  (pause)
(d-DirectiveDelete-chord "ChordsOverBass")
	      (d-PopPosition)
	      (d-DirectiveDelete-chord "ChordsOverBass")
	      
	      (if (d-NextObject)
		  (loop (d-GetNoteAsMidi))))))
  (disp "Finished ChordsOverBass")))


(define Pitchbend::commandUp "(d-CursorRight)")
(define Pitchbend::commandDown "(d-CursorLeft)")
</scheme>
        <label>Create Chords Over Bass Line</label>
        <tooltip>Place the cursor on a bass note and invoke this command. It creates a treble staff above and for each note in the bass staff, as you play it, it switches to the treble staff and allows you to enter a chord. Use the Pitch Bend wheel to stop/start the process. Hold a chord while moving to the next bass note to extend the chord over more than one bass note.</tooltip>
      </row>
    </map>
  </merge>
</Denemo>
