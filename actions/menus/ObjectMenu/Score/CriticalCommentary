<?xml version="1.0"?>
<Denemo>
  <merge>
    <title>A Denemo Keymap</title>
    <author>AT, JRR, RTS</author>
    <map>
      <row>
        <after>ReduceSystemSpacing</after>
        <action>CriticalCommentary</action>
        <scheme>;;;;;;;;CriticalCommentary
(d-PushPosition)
(while (d-PreviousMovement))
(let ()
  (define (format-commentary thelist)
    (define ret "")
    (let loop ((count 0))
      (if (&lt; count (length thelist))
	(begin
	  (set! ret (string-append ret "\n\\markup { \\wordwrap-string #\"" (number-&gt;string (+ 1 count)) ". "
	    (list-ref thelist count) "\"}\n"))
	  (loop (+ 1 count)))))
  ret)
 (define thecomments '())
 (define ok #f)
 (define tag "CriticalComment")
 
 (let movement ()
  (define movement-number (number-&gt;string (d-GetMovement)))
  (define voice 1)
  (while (d-MoveToStaffUp))
  (d-MoveToBeginning)

  (let measure ()
      (define measure-number (number-&gt;string (d-GetMeasure)))
      (define thecomment #f)
	(let loop ()
	  (if (d-Directive-standalone? tag) 
	    (begin
	      (set! ok #t)
	      (set! thecomment (d-DirectiveGet-standalone-display tag))
	      (set! thecomments (cons* (string-append "At m" movement-number " v" (number-&gt;string voice) " b" measure-number ": " thecomment) thecomments))))
	    (if (NextDirectiveOfTagInMeasure tag)
	      (loop)))	     
	(if (or (d-MoveToVoiceDown) (d-MoveToStaffDown))
	  (begin
	    (set! voice (+ 1 voice))
	    (measure))
	  (begin
	    (if (d-MoveToMeasureRight)
		(begin
		  (while  (d-MoveToStaffUp))
		  (set! voice 1)
		  (measure))))))
			    
  (if (d-NextMovement)
	(movement)
	(begin
	    (if ok
	      (begin
		(d-SetSaved #f) 
		(d-LilyPondInclude "book-titling.ily")
		(d-LilyPondInclude "simplified-book-titling.ily")
		(d-DirectivePut-score-override "CriticalCommentary" DENEMO_OVERRIDE_AFFIX)
		(d-DirectivePut-score-postfix "CriticalCommentary" (string-append "\\pageBreak\n\\titledPiece \\markup \"Critical Commentary\"\n\\markup { \\fill-line {\\postscript #\"-12 3 moveto 24 0 rlineto stroke\"}}\n\\markup {\\italic \\wordwrap-string #\"Key: m = Movement, v = voice, b = bar\"}\n"  (format-commentary (reverse thecomments)))))
	      (d-InfoDialog "No critical comments found\nUse Directive-&gt;Critical Comment to insert these")))))) 				
(d-PopPosition)</scheme>
        <label>Create Critical Commentary</label>
        <tooltip>Collects together critical comments from the score and places them at the end of the music.</tooltip>
      </row>
    </map>
  </merge>
</Denemo>
